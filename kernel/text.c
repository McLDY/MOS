/*
                   _ooOoo_
                  o8888888o
                  88" . "88
                  (| -_- |)
                  O\  =  /O
               ____/`---'\____
             .'  \\|     |//  `.
            /  \\|||  :  |||//  \
           /  _||||| -:- |||||-  \
           |   | \\\  -  /// |   |
           | \_|  ''\---/''  |   |
           \  .-\__  `-`  ___/-. /
         ___`. .'  /--.--\  `. . __
      ."" '<  `.___\_<|>_/___.'  >'"".
     | | :  `- \`.;`\ _ /`;.`/ - ` : | |
     \  \ `-.   \_ __\ /__ _/   .-` /  /
======`-.____`-.___\_____/___.-`____.-'======
                   `=---='
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            佛祖保佑       永无BUG
*/

#include "chinese_font.h"
#include <graphics.h>
#include <stddef.h>
#include <stdint.h>

// 16x8 ASCII 字形表 (字符 32..126)
static const uint8_t font16x8_basic[95][16] = {
    /* 0x20 ' ' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 0x21 '!' */ {0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,
                    0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 0x22 '"' */ {0x00,0x6C,0x6C,0x6C,0x6C,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 0x23 '#' */ {0x00,0x00,0x36,0x36,0x7F,0x36,0x36,0x36,
                    0x36,0x7F,0x36,0x36,0x00,0x00,0x00,0x00},
    /* 0x24 '$' */ {0x00,0x08,0x3E,0x6B,0x0B,0x0B,0x3E,0x68,
                    0x68,0x6B,0x3E,0x08,0x00,0x00,0x00,0x00},
    /* 0x25 '%' */ {0x00,0x00,0x33,0x33,0x18,0x0C,0x06,0x03,
                    0x06,0x0C,0x18,0x33,0x33,0x00,0x00,0x00},
    /* 0x26 '&' */ {0x00,0x00,0x1E,0x33,0x33,0x1E,0x1C,0x36,
                    0x63,0x63,0x63,0x36,0x00,0x00,0x00,0x00},
    /* 0x27 ''' */ {0x00,0x0C,0x0C,0x0C,0x06,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 0x28 '(' */ {0x00,0x30,0x18,0x0C,0x06,0x06,0x06,0x06,
                    0x06,0x06,0x0C,0x18,0x30,0x00,0x00,0x00},
    /* 0x29 ')' */ {0x00,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,
                    0x30,0x30,0x18,0x0C,0x06,0x00,0x00,0x00},
    /* 0x2A '*' */ {0x00,0x00,0x00,0x00,0x63,0x36,0x1C,0x7F,
                    0x1C,0x36,0x63,0x00,0x00,0x00,0x00,0x00},
    /* 0x2B '+' */ {0x00,0x00,0x00,0x00,0x18,0x18,0x18,0xFF,
                    0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    /* 0x2C ',' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x0C,0x0C,0x0C,0x06,0x00,0x00},
    /* 0x2D '-' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 0x2E '.' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x0C,0x0C,0x00,0x00,0x00,0x00},
    /* 0x2F '/' */ {0x00,0x60,0x60,0x30,0x30,0x18,0x18,0x0C,
                    0x0C,0x06,0x06,0x03,0x03,0x00,0x00,0x00},
    /* 0x30 '0' */ {0x00,0x00,0x3E,0x63,0x63,0x67,0x6B,0x6B,
                    0x73,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x31 '1' */ {0x00,0x00,0x0C,0x1C,0x3C,0x0C,0x0C,0x0C,
                    0x0C,0x0C,0x0C,0x3F,0x00,0x00,0x00,0x00},
    /* 0x32 '2' */ {0x00,0x00,0x3E,0x63,0x60,0x60,0x30,0x18,
                    0x0C,0x06,0x03,0x7F,0x00,0x00,0x00,0x00},
    /* 0x33 '3' */ {0x00,0x00,0x3E,0x63,0x60,0x60,0x3C,0x60,
                    0x60,0x60,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x34 '4' */ {0x00,0x00,0x30,0x38,0x3C,0x36,0x33,0x7F,
                    0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    /* 0x35 '5' */ {0x00,0x00,0x7F,0x03,0x03,0x3F,0x60,0x60,
                    0x60,0x60,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x36 '6' */ {0x00,0x00,0x3C,0x06,0x03,0x03,0x3F,0x63,
                    0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x37 '7' */ {0x00,0x00,0x7F,0x60,0x60,0x30,0x30,0x18,
                    0x18,0x0C,0x0C,0x0C,0x00,0x00,0x00,0x00},
    /* 0x38 '8' */ {0x00,0x00,0x3E,0x63,0x63,0x63,0x3E,0x63,
                    0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x39 '9' */ {0x00,0x00,0x3E,0x63,0x63,0x63,0x7E,0x60,
                    0x60,0x60,0x30,0x1E,0x00,0x00,0x00,0x00},
    /* 0x3A ':' */ {0x00,0x00,0x00,0x00,0x0C,0x0C,0x00,0x00,
                    0x00,0x0C,0x0C,0x00,0x00,0x00,0x00,0x00},
    /* 0x3B ';' */ {0x00,0x00,0x00,0x00,0x0C,0x0C,0x00,0x00,
                    0x00,0x0C,0x0C,0x0C,0x06,0x00,0x00,0x00},
    /* 0x3C '<' */ {0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x03,
                    0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00},
    /* 0x3D '=' */ {0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,
                    0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 0x3E '>' */ {0x00,0x00,0x03,0x06,0x0C,0x18,0x30,0x60,
                    0x30,0x18,0x0C,0x06,0x03,0x00,0x00,0x00},
    /* 0x3F '?' */ {0x00,0x00,0x3E,0x63,0x63,0x30,0x18,0x18,
                    0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 0x40 '@' */ {0x00,0x00,0x3E,0x63,0x63,0x7B,0x7B,0x7B,
                    0x7B,0x03,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x41 'A' */ {0x00,0x00,0x1C,0x36,0x63,0x63,0x63,0x7F,
                    0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* 0x42 'B' */ {0x00,0x00,0x3F,0x66,0x66,0x66,0x3E,0x66,
                    0x66,0x66,0x66,0x3F,0x00,0x00,0x00,0x00},
    /* 0x43 'C' */ {0x00,0x00,0x3C,0x66,0x03,0x03,0x03,0x03,
                    0x03,0x03,0x66,0x3C,0x00,0x00,0x00,0x00},
    /* 0x44 'D' */ {0x00,0x00,0x1F,0x36,0x66,0x66,0x66,0x66,
                    0x66,0x66,0x36,0x1F,0x00,0x00,0x00,0x00},
    /* 0x45 'E' */ {0x00,0x00,0x7F,0x46,0x06,0x16,0x1E,0x16,
                    0x06,0x06,0x46,0x7F,0x00,0x00,0x00,0x00},
    /* 0x46 'F' */ {0x00,0x00,0x7F,0x46,0x06,0x16,0x1E,0x16,
                    0x06,0x06,0x06,0x0F,0x00,0x00,0x00,0x00},
    /* 0x47 'G' */ {0x00,0x00,0x3C,0x66,0x03,0x03,0x03,0x73,
                    0x63,0x63,0x66,0x7C,0x00,0x00,0x00,0x00},
    /* 0x48 'H' */ {0x00,0x00,0x63,0x63,0x63,0x63,0x7F,0x63,
                    0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* 0x49 'I' */ {0x00,0x00,0x3F,0x0C,0x0C,0x0C,0x0C,0x0C,
                    0x0C,0x0C,0x0C,0x3F,0x00,0x00,0x00,0x00},
    /* 0x4A 'J' */ {0x00,0x00,0x78,0x30,0x30,0x30,0x30,0x30,
                    0x33,0x33,0x33,0x1E,0x00,0x00,0x00,0x00},
    /* 0x4B 'K' */ {0x00,0x00,0x67,0x66,0x36,0x36,0x1E,0x1E,
                    0x36,0x36,0x66,0x67,0x00,0x00,0x00,0x00},
    /* 0x4C 'L' */ {0x00,0x00,0x0F,0x06,0x06,0x06,0x06,0x06,
                    0x06,0x46,0x66,0x7F,0x00,0x00,0x00,0x00},
    /* 0x4D 'M' */ {0x00,0x00,0x63,0x77,0x7F,0x7F,0x6B,0x63,
                    0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* 0x4E 'N' */ {0x00,0x00,0x63,0x63,0x73,0x7B,0x7F,0x6F,
                    0x67,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* 0x4F 'O' */ {0x00,0x00,0x1C,0x36,0x63,0x63,0x63,0x63,
                    0x63,0x63,0x36,0x1C,0x00,0x00,0x00,0x00},
    /* 0x50 'P' */ {0x00,0x00,0x3F,0x66,0x66,0x66,0x3E,0x06,
                    0x06,0x06,0x06,0x0F,0x00,0x00,0x00,0x00},
    /* 0x51 'Q' */ {0x00,0x00,0x1C,0x36,0x63,0x63,0x63,0x63,
                    0x63,0x6F,0x36,0x1C,0x30,0x60,0x00,0x00},
    /* 0x52 'R' */ {0x00,0x00,0x3F,0x66,0x66,0x66,0x3E,0x36,
                    0x66,0x66,0x66,0x67,0x00,0x00,0x00,0x00},
    /* 0x53 'S' */ {0x00,0x00,0x3E,0x63,0x63,0x06,0x1C,0x30,
                    0x60,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x54 'T' */ {0x00,0x00,0x7E,0x7E,0x5A,0x18,0x18,0x18,
                    0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 0x55 'U' */ {0x00,0x00,0x63,0x63,0x63,0x63,0x63,0x63,
                    0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x56 'V' */ {0x00,0x00,0x63,0x63,0x63,0x63,0x63,0x63,
                    0x63,0x36,0x1C,0x08,0x00,0x00,0x00,0x00},
    /* 0x57 'W' */ {0x00,0x00,0x63,0x63,0x63,0x63,0x6B,0x6B,
                    0x7F,0x77,0x63,0x63,0x00,0x00,0x00,0x00},
    /* 0x58 'X' */ {0x00,0x00,0x63,0x63,0x63,0x36,0x1C,0x1C,
                    0x36,0x63,0x63,0x63,0x00,0x00,0x00,0x00},
    /* 0x59 'Y' */ {0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x18,
                    0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 0x5A 'Z' */ {0x00,0x00,0x7F,0x63,0x61,0x30,0x18,0x0C,
                    0x06,0x43,0x63,0x7F,0x00,0x00,0x00,0x00},
    /* 0x5B '[' */ {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,
                    0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    /* 0x5C '\' */ {0x00,0x03,0x03,0x06,0x06,0x0C,0x0C,0x18,
                    0x18,0x30,0x30,0x60,0x60,0x00,0x00,0x00},
    /* 0x5D ']' */ {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,
                    0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    /* 0x5E '^' */ {0x00,0x08,0x1C,0x36,0x63,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 0x5F '_' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00},
    /* 0x60 '`' */ {0x00,0x0C,0x0C,0x18,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 0x61 'a' */ {0x00,0x00,0x00,0x00,0x00,0x3E,0x60,0x7E,
                    0x63,0x63,0x63,0x7E,0x00,0x00,0x00,0x00},
    /* 0x62 'b' */ {0x00,0x00,0x07,0x06,0x06,0x3E,0x66,0x66,
                    0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00},
    /* 0x63 'c' */ {0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x03,
                    0x03,0x03,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x64 'd' */ {0x00,0x00,0x70,0x30,0x30,0x3E,0x33,0x33,
                    0x33,0x33,0x33,0x7E,0x00,0x00,0x00,0x00},
    /* 0x65 'e' */ {0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x63,
                    0x7F,0x03,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x66 'f' */ {0x00,0x00,0x38,0x6C,0x0C,0x0C,0x3F,0x0C,
                    0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    /* 0x67 'g' */ {0x00,0x00,0x00,0x00,0x00,0x7E,0x33,0x33,
                    0x33,0x33,0x33,0x3E,0x30,0x33,0x1E,0x00},
    /* 0x68 'h' */ {0x00,0x00,0x07,0x06,0x06,0x36,0x6E,0x66,
                    0x66,0x66,0x66,0x67,0x00,0x00,0x00,0x00},
    /* 0x69 'i' */ {0x00,0x00,0x18,0x18,0x00,0x1C,0x18,0x18,
                    0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 0x6A 'j' */ {0x00,0x00,0x60,0x60,0x00,0x78,0x60,0x60,
                    0x60,0x60,0x60,0x60,0x66,0x66,0x3C,0x00},
    /* 0x6B 'k' */ {0x00,0x00,0x07,0x06,0x06,0x66,0x36,0x1E,
                    0x1E,0x36,0x66,0x67,0x00,0x00,0x00,0x00},
    /* 0x6C 'l' */ {0x00,0x00,0x1C,0x18,0x18,0x18,0x18,0x18,
                    0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 0x6D 'm' */ {0x00,0x00,0x00,0x00,0x00,0x37,0x7F,0x6B,
                    0x6B,0x6B,0x6B,0x6B,0x00,0x00,0x00,0x00},
    /* 0x6E 'n' */ {0x00,0x00,0x00,0x00,0x00,0x37,0x6E,0x66,
                    0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    /* 0x6F 'o' */ {0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x63,
                    0x63,0x63,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x70 'p' */ {0x00,0x00,0x00,0x00,0x00,0x3E,0x66,0x66,
                    0x66,0x66,0x66,0x3E,0x06,0x06,0x07,0x00},
    /* 0x71 'q' */ {0x00,0x00,0x00,0x00,0x00,0x7E,0x33,0x33,
                    0x33,0x33,0x33,0x3E,0x30,0x30,0x70,0x00},
    /* 0x72 'r' */ {0x00,0x00,0x00,0x00,0x00,0x37,0x6E,0x66,
                    0x06,0x06,0x06,0x0F,0x00,0x00,0x00,0x00},
    /* 0x73 's' */ {0x00,0x00,0x00,0x00,0x00,0x3E,0x63,0x06,
                    0x1C,0x30,0x63,0x3E,0x00,0x00,0x00,0x00},
    /* 0x74 't' */ {0x00,0x00,0x00,0x0C,0x0C,0x3F,0x0C,0x0C,
                    0x0C,0x0C,0x6C,0x38,0x00,0x00,0x00,0x00},
    /* 0x75 'u' */ {0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x33,
                    0x33,0x33,0x33,0x7E,0x00,0x00,0x00,0x00},
    /* 0x76 'v' */ {0x00,0x00,0x00,0x00,0x00,0x63,0x63,0x63,
                    0x63,0x36,0x1C,0x08,0x00,0x00,0x00,0x00},
    /* 0x77 'w' */ {0x00,0x00,0x00,0x00,0x00,0x63,0x63,0x6B,
                    0x6B,0x7F,0x77,0x63,0x00,0x00,0x00,0x00},
    /* 0x78 'x' */ {0x00,0x00,0x00,0x00,0x00,0x63,0x36,0x1C,
                    0x1C,0x1C,0x36,0x63,0x00,0x00,0x00,0x00},
    /* 0x79 'y' */ {0x00,0x00,0x00,0x00,0x00,0x63,0x63,0x63,
                    0x63,0x63,0x63,0x7E,0x60,0x30,0x1F,0x00},
    /* 0x7A 'z' */ {0x00,0x00,0x00,0x00,0x00,0x7F,0x33,0x18,
                    0x0C,0x06,0x63,0x7F,0x00,0x00,0x00,0x00},
    /* 0x7B '{' */ {0x00,0x00,0x70,0x18,0x18,0x18,0x18,0x0E,
                    0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00},
    /* 0x7C '|' */ {0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,
                    0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00},
    /* 0x7D '}' */ {0x00,0x00,0x0E,0x18,0x18,0x18,0x18,0x70,
                    0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00},
    /* 0x7E '~' */ {0x00,0x00,0x6E,0x3B,0x00,0x00,0x00,0x00,
                    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

// 位反转函数：将字节的位顺序反转
static inline uint8_t reverse_bits(uint8_t b) {
    b = (b & 0xF0) >> 4 | (b & 0x0F) << 4;
    b = (b & 0xCC) >> 2 | (b & 0x33) << 2;
    b = (b & 0xAA) >> 1 | (b & 0x55) << 1;
    return b;
}

void print_mixed_string(const char *str, uint32_t x, uint32_t y, uint32_t color)
{
    if (!str || !g_framebuffer)
        return;
    
    uint32_t current_x = x;
    uint32_t current_y = y;
    
    while (*str)
    {
        // 检查是否为中文（UTF-8编码）
        if ((*str & 0x80) == 0)
        {
            // ASCII字符
            put_char(*str, current_x, current_y, color);
            current_x += FONT_W + 1;
            str++;
        }
        else if ((*str & 0xE0) == 0xC0 && (str[1] & 0xC0) == 0x80)
        {
            // 2字节中文字符
            uint16_t unicode = ((*str & 0x1F) << 6) | (str[1] & 0x3F);
            put_chinese_char(unicode, current_x, current_y, color);
            current_x += CHINESE_FONT_W + 1;
            str += 2;
        }
        else if ((*str & 0xF0) == 0xE0 && (str[1] & 0xC0) == 0x80 && (str[2] & 0xC0) == 0x80)
        {
            // 3字节中文字符
            uint16_t unicode = ((*str & 0x0F) << 12) | 
                              ((str[1] & 0x3F) << 6) | 
                              (str[2] & 0x3F);
            put_chinese_char(unicode, current_x, current_y, color);
            current_x += CHINESE_FONT_W + 1;
            str += 3;
        }
        else
        {
            // 无效字符，显示为方框
            for (uint32_t _y = 0; _y < CHINESE_FONT_H; _y++)
            {
                for (uint32_t _x = 0; _x < CHINESE_FONT_W; _x++)
                {
                    uint32_t pixel_x = current_x + _x;
                    uint32_t pixel_y = current_y + _y;
                    
                    if (_x == 0 || _x == CHINESE_FONT_W - 1 || 
                        _y == 0 || _y == CHINESE_FONT_H - 1)
                    {
                        put_pixel(pixel_x, pixel_y, color);
                    }
                }
            }
            current_x += CHINESE_FONT_W + 1;
            str++;
        }
    }
}


void put_char(char c, uint32_t x, uint32_t y, uint32_t color)
{
    if (!g_framebuffer)
        return;
    if (c < 32 || c > 126)
        c = '?';
    const uint8_t *glyph = font16x8_basic[(uint8_t)c - 32];

    for (uint32_t _y = 0; _y < FONT_H; _y++)
    {
        uint8_t bits = glyph[_y];
        // 反转位顺序，确保最高位对应最左侧像素
        bits = reverse_bits(bits);
        
        for (uint32_t _x = 0; _x < FONT_W; _x++)
        {
            if (bits & (1 << (7 - _x)))  // 现在最高位对应最左侧像素
            {
                put_pixel(x + _x, y + _y, color);
            }
        }
    }
}

// 输出字符串函数
void print_string(const char *str, uint32_t x, uint32_t y, uint32_t color)
{
    print_mixed_string(str, x, y, color);
}

// 字库中字符数量
#define CHINESE_FONT_SIZE (sizeof(chinese_font_basic) / sizeof(chinese_glyph_t))

// 查找字库中的字符
const chinese_glyph_t* find_chinese_glyph(uint16_t unicode)
{
    for (uint32_t i = 0; i < CHINESE_FONT_SIZE; i++)
    {
        if (chinese_font_basic[i].unicode == unicode)
        {
            return &chinese_font_basic[i];
        }
    }
    return NULL;
}

// 显示单个中文字符
void put_chinese_char(uint16_t unicode, uint32_t x, uint32_t y, uint32_t color)
{
    if (!g_framebuffer)
        return;
        
    const chinese_glyph_t* glyph = find_chinese_glyph(unicode);
    if (!glyph)
    {
        // 如果找不到字符，显示方框
        for (uint32_t _y = 0; _y < CHINESE_FONT_H; _y++)
        {
            for (uint32_t _x = 0; _x < CHINESE_FONT_W; _x++)
            {
                uint32_t pixel_x = x + _x;
                uint32_t pixel_y = y + _y;
                
                // 绘制边框
                if (_x == 0 || _x == CHINESE_FONT_W - 1 || 
                    _y == 0 || _y == CHINESE_FONT_H - 1)
                {
                    put_pixel(pixel_x, pixel_y, color);
                }
            }
        }
        return;
    }
    
    // 绘制字形位图
    for (uint32_t _y = 0; _y < CHINESE_FONT_H; _y++)
    {
        uint8_t byte_low = glyph->bitmap[_y * 2];
        uint8_t byte_high = glyph->bitmap[_y * 2 + 1];
        
        for (uint32_t _x = 0; _x < 16; _x++)
        {
            uint8_t bit;
            if (_x < 8)
                bit = (byte_low >> (7 - _x)) & 1;
            else
                bit = (byte_high >> (15 - _x)) & 1;
                
            if (bit)
            {
                put_pixel(x + _x, y + _y, color);
            }
        }
    }
}

// 显示Unicode字符串
void print_chinese_string(const uint16_t *unicode_str, uint32_t x, uint32_t y, uint32_t color)
{
    if (!unicode_str || !g_framebuffer)
        return;
    
    uint32_t current_x = x;
    uint32_t current_y = y;
    
    while (*unicode_str)
    {
        put_chinese_char(*unicode_str, current_x, current_y, color);
        current_x += CHINESE_FONT_W + 1;  // 字符宽度 + 1像素间距
        unicode_str++;
    }
}

// UTF-8到Unicode的简化转换（仅处理2-3字节UTF-8）
static uint16_t utf8_to_unicode(const char *utf8, uint32_t *advance)
{
    if ((*utf8 & 0x80) == 0)
    {
        // 1字节ASCII字符
        *advance = 1;
        return (uint16_t)(*utf8);
    }
    else if ((*utf8 & 0xE0) == 0xC0 && (utf8[1] & 0xC0) == 0x80)
    {
        // 2字节字符
        *advance = 2;
        return (uint16_t)(((*utf8 & 0x1F) << 6) | (utf8[1] & 0x3F));
    }
    else if ((*utf8 & 0xF0) == 0xE0 && (utf8[1] & 0xC0) == 0x80 && (utf8[2] & 0xC0) == 0x80)
    {
        // 3字节字符
        *advance = 3;
        return (uint16_t)(((*utf8 & 0x0F) << 12) | 
                         ((utf8[1] & 0x3F) << 6) | 
                         (utf8[2] & 0x3F));
    }
    else
    {
        // 无效UTF-8，使用替代字符
        *advance = 1;
        return 0xFFFD;
    }
}

// 显示UTF-8字符串
void print_utf8_string(const char *utf8_str, uint32_t x, uint32_t y, uint32_t color)
{
    if (!utf8_str || !g_framebuffer)
        return;
    
    uint32_t current_x = x;
    uint32_t current_y = y;
    
    while (*utf8_str)
    {
        uint32_t advance;
        uint16_t unicode = utf8_to_unicode(utf8_str, &advance);
        
        if (unicode < 128)
        {
            // ASCII字符，使用原有字体
            put_char((char)unicode, current_x, current_y, color);
            current_x += FONT_W + 1;
        }
        else
        {
            // 中文字符
            put_chinese_char(unicode, current_x, current_y, color);
            current_x += CHINESE_FONT_W + 1;
        }
        
        utf8_str += advance;
    }
}

// 混合显示：ASCII + 中文
